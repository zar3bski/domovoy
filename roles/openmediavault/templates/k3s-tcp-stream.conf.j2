stream {
    upstream omv-hci {
        server 127.0.0.1:444;
    }

    upstream k3s-insecure {
        server 127.0.0.1:8080;
    }

    upstream k3s-websecure {
        server 127.0.0.1:8443;
    }

    upstream k3s-dashboard {
        server 127.0.0.1:4443;
    }
    
    map $ssl_preread_server_name $name {
        omv.{{ inventory_hostname }} omv-hci;
        dashboard.{{ inventory_hostname }} k3s-dashboard;
        default k3s-websecure;
    }

    server {
        listen 443;
        proxy_protocol on;
        proxy_pass $name;
        ssl_preread on;
        proxy_timeout 3s;
        proxy_connect_timeout 3s;
    }

    server {
        listen 80;
        proxy_protocol on;
        proxy_pass k3s-insecure;
        proxy_timeout 3s;
        proxy_connect_timeout 3s;
    }
}
